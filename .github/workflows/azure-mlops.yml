name: mlops-automation

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  GROUP: azure-ai
  WORKSPACE: tomasrojka-ml
  LOCATION: westeurope

jobs:
  # ------------------------------------------
  # 1) Run Azure ML pipeline (compute + env + components + job)
  # ------------------------------------------
  azure-pipeline:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # sanity check that az is logged in on this machine
      - name: Check Azure CLI identity
        run: az account show

      - name: Azure – Create compute + envs + components + pipeline run
        id: submit_job
        run: |
          az extension add --name ml -y
          az configure --defaults group=$env:GROUP workspace=$env:WORKSPACE location=$env:LOCATION

          # 1. Compute (ignore error if it already exists)
          az ml compute create --file environment/compute.yaml 2>$null

          # 2. Environments (ignore if already exist)
          foreach ($envName in @("preprocessing", "training")) {
            az ml environment create --file "environment/$envName.yaml" 2>$null
          }

          # 3. Components
          $components = @(
            "components/dataprep/dataprep.yaml",
            "components/dataprep/traintestsplit.yaml",
            "components/training/training.yaml"
          )
          foreach ($comp in $components) {
            az ml component create --file $comp
          }

          # 4. Run pipeline
          $jobName = az ml job create `
            --file pipelines/animals-classification.yaml `
            --query name -o tsv

          echo "job_name=$jobName" >> $env:GITHUB_OUTPUT

          # 5. Stop compute (best effort)
          az ml compute stop --name cli-created-machine 2>$null

    outputs:
      job_name: ${{ steps.submit_job.outputs.job_name }}

  # ------------------------------------------
  # 2) DOWNLOAD – grab latest registered model + upload inference code
  # ------------------------------------------
  download:
    needs: azure-pipeline
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Azure CLI identity
        run: az account show

      - name: Azure – Download latest model
        run: |
          az extension add --name ml -y
          az configure --defaults group=$env:GROUP workspace=$env:WORKSPACE location=$env:LOCATION

          # Get latest version of your registered model
          $version = az ml model list -n animal-classification `
            --query "[0].version" -o tsv

          echo "Latest model version: $version"

          # Download into inference/model (used as Docker build context)
          az ml model download `
            --name animal-classification `
            --version $version `
            --download-path inference/model `
            --overwrite

      # upload inference/ (API code + downloaded model) as artifact
      - name: Docker – Upload API code from inference
        uses: actions/upload-artifact@v4
        with:
          name: docker-config
          path: inference

  # ------------------------------------------
  # 3) DEPLOY – build Docker image + push to Docker Hub
  # ------------------------------------------
  deploy:
    needs: download
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # bring back inference/ (API code + model) from previous job
      - name: Download API + model artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-config
          path: inference

      # create image tags/labels
      - name: Docker – Gather tags
        id: docker-meta-data
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/tomasrojka/animals-api
          tags: |
            type=ref,event=branch
            type=sha
            type=raw,value=latest

      # log in to Docker Hub (you already created these secrets)
      - name: Docker – Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # build + push container using inference/ as build context
      - name: Docker – Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./inference
          push: true
          tags: ${{ steps.docker-meta-data.outputs.tags }}
          labels: ${{ steps.docker-meta-data.outputs.labels }}
