name: mlops-automation

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  GROUP: azure-ai
  WORKSPACE: tomasrojka-ml
  LOCATION: westeurope

jobs:

  # ============================================
  # 1) AZURE PIPELINE (best-effort)
  # ============================================
  azure-pipeline:
    runs-on: self-hosted   # your runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Azure CLI identity
        shell: bash
        run: |
          echo "=== Checking Azure CLI identity ==="
          az account show || echo "⚠ Not logged into Azure (expected on self-hosted)"

      - name: Azure – Submit pipeline job (best-effort)
        id: submit_job
        shell: bash
        continue-on-error: true   # OPTION A
        run: |
          echo "=== Installing Azure ML extension ==="
          az extension add --name ml -y

          echo "=== Setting defaults ==="
          az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION

          echo "=== Submitting Pipeline (best effort) ==="
          jobName=$(az ml job create --file pipelines/animals-classification.yaml --query name -o tsv 2>/dev/null)
          if [ -z "$jobName" ]; then
            echo "⚠ Pipeline failed (expected on student accounts)"
          fi

          echo "job_name=$jobName" >> $GITHUB_OUTPUT

    outputs:
      job_name: ${{ steps.submit_job.outputs.job_name }}

  # ============================================
  # 2) DOWNLOAD MODEL
  # ============================================
  download:
    needs: azure-pipeline
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure – Download latest model
        uses: azure/CLI@v2
        with:
          inlineScript: |
            az extension add --name ml -y
            az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION

            VERSION=$(az ml model list -n animal-classification --query "[0].version" -o tsv)
            echo "Latest model version: $VERSION"

            az ml model download \
              --name animal-classification \
              --version $VERSION \
              --download-path inference/model \
              --overwrite

      - name: Upload inference folder as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-config
          path: inference

  # ============================================
  # 3) DOCKER BUILD + PUSH
  # ============================================
  deploy:
    needs: download
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-config
          path: inference

      - name: Docker metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: docker.io/tomasrojka/animals-api
          tags: |
            type=ref,event=branch
            type=sha
            type=raw,value=latest

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ./inference
          push: true
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
