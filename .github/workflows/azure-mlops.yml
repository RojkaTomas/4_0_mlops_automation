name: mlops-automation

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  GROUP: azure-ai
  WORKSPACE: tomasrojka-ml
  LOCATION: westeurope

jobs:

  # =============================================================
  # 1) RUN AZURE PIPELINE (best effort) ON WINDOWS SELF-HOSTED
  # =============================================================
  azure-pipeline:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Azure CLI identity
        shell: powershell
        run: |
          Write-Host "=== Checking Azure CLI identity ==="
          az account show 2>$null
          if ($LASTEXITCODE -ne 0) {
            Write-Host "⚠ Not logged in to Azure (expected)"
          }

      - name: Azure – Submit AML pipeline (best effort)
        id: submit_job
        shell: powershell
        continue-on-error: true
        run: |
          Write-Host "=== Installing Azure ML extension ==="
          az extension add --name ml -y

          Write-Host "=== Setting defaults ==="
          az configure --defaults group=$env:GROUP workspace=$env:WORKSPACE location=$env:LOCATION

          Write-Host "=== Submitting AML pipeline ==="
          $jobName = az ml job create --file pipelines/animals-classification.yaml --query name -o tsv 2>$null

          if (-not $jobName) {
            Write-Host "⚠ Pipeline submission failed — continuing anyway"
          }

          "job_name=$jobName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    outputs:
      job_name: ${{ steps.submit_job.outputs.job_name }}

  # =============================================================
  # 2) DOWNLOAD MODEL ON UBUNTU HOSTED RUNNER
  # =============================================================
  download:
    needs: azure-pipeline
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Skip Azure login (no SP permissions in student subscription)
        run: echo "Skipping Azure login"

      - name: Use local inference model folder directly
        run: echo "Using static model from repo (assignment-compatible)"

      - name: Upload inference folder as artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-config
          path: inference


  # =============================================================
  # 3) DOCKER BUILD + PUSH ON UBUNTU RUNNER
  # =============================================================
  deploy:
    needs: download
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download API + model artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-config
          path: inference

      - name: Docker – Gather tags
        id: docker-meta-data
        uses: docker/metadata-action@v5
        with:
          images: tomasrojka/animals-api
          tags: |
            type=ref,event=branch
            type=sha
            type=raw,value=latest

      - name: Docker – Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker – Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./inference
          push: true
          tags: ${{ steps.docker-meta-data.outputs.tags }}
          labels: ${{ steps.docker-meta-data.outputs.labels }}
